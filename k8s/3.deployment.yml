apiVersion: apps/v1
kind: Deployment
metadata:
  name: hybrid-auth-service
  labels:
    app: hybrid-auth-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hybrid-auth-service
  template:
    metadata:
      labels:
        app: hybrid-auth-service
    spec:
      # --- INIT CONTAINER PARA MIGRACIONES ---
      # initContainers:
      # - name: db-migration
      #   image: wz76yl02.c1.bhs5.container-registry.ovh.net/hybrid/hybrid-api-ts:latest
      #   envFrom:
      #     - configMapRef:
      #         name: hybrid-api-config
      #     - secretRef:
      #         name: hybrid-api-secret
      #   # Usar bash para manejar errores de migraci√≥n
      #   command: ["/bin/sh"]
      #   args: 
      #     - "-c"
      #     - |
      #       echo "üöÄ Iniciando migraciones de base de datos..."
      #       if npm run migration:run:prod; then
      #         echo "‚úÖ Migraciones completadas exitosamente"
      #         exit 0
      #       else
      #         echo "‚ö†Ô∏è Error en migraciones - verificando si es duplicado..."
      #         if npm run migration:run:prod 2>&1 | grep -q "Duplicate key"; then
      #           echo "‚ö†Ô∏è Error de duplicado detectado - continuando"
      #           exit 0
      #         else
      #           echo "‚ùå Error cr√≠tico en migraciones"
      #           exit 1
      #         fi
      #       fi
      #   resources:
      #     requests:
      #       cpu: "100m"
      #       memory: "128Mi"
      #     limits:
      #       cpu: "300m"
      #       memory: "256Mi"

      containers:
        - name: hybrid-auth-service
          image: wz76yl02.c1.bhs5.container-registry.ovh.net/hybrid/hybrid-api-ts:latest
          ports:
            - containerPort: 3001
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          envFrom:
            - configMapRef:
                name: hybrid-api-config
            - secretRef:
                name: hybrid-api-secret
          # livenessProbe:
          #   httpGet:
          #     path: /api/v1/health
          #     port: 3001
          #   initialDelaySeconds: 30
          #   periodSeconds: 10
          # readinessProbe:
          #   httpGet:
          #     path: /api/v1/health
          #     port: 3001
          #   initialDelaySeconds: 5
          #   periodSeconds: 5
      imagePullSecrets:
       - name: regcred
---
apiVersion: v1
kind: Service
metadata:
  name: hybrid-auth-service
spec:
  type: ClusterIP
  selector:
    app: hybrid-auth-service
  ports:
    - protocol: TCP
      port: 3001
      targetPort: 3001